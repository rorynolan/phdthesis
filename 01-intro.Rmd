# Introduction {#intro}


## Confocal light microscopy

All of the images used in my PhD were collected on a confocal microscope. This type of microscope guarantees that only in-focus light is collected at the detector. See figure \@ref(fig:confocal).

(ref:confocal-caption) Confocal microscope light path showing how out of focus light does not make it to the detector.^[Image courtesy of Quora: https://www.quora.com/How-does-confocal-microscopy-work]

```{r confocal, fig.cap='(ref:confocal-caption)', out.width='70%', echo=FALSE}
include_graphics(here("img", "quora_confocal.jpeg"))
```

```{definition}
The _confocal volume_ is the _in-focus_ volume within a sample that is efficiently detected using a system designed with confocal optics.^[http://www.fcsxpert.com/classroom/theory/what-is-confocal-volume.html]
```

An image is acquired on a confocal microscope by scanning this apparatus across a sample, collecting one pixel at a time. Some confocal detectors collect intensity in arbitrary units but others are capable of photon-counting. The work in this thesis was carried out with photon-counting detectors.

```{remark}
Henceforth, intensity counts will be assumed to be in units of photons.
```


## Intensity traces

```{definition}
A _fluorophore_ is a fluorescent chemical compound that can re-emit light upon light excitation.^[https://en.wikipedia.org/wiki/Fluorophore]
```

Fluorophores under constant excitation emit light one photon at a time according to a poisson statistics^[https://en.wikipedia.org/wiki/Poisson_distribution] with some poisson rate. 

Consider figure \@ref(fig:confocal-volume-particle). A fluorophore enters the confocal volume, is excited there and emits photons which are collected by the detector. When the fluorophore is not in the confocal volume (start and end), no photons are detected. When the particle is in the confocal volume, photons it emits are collected at the detector. Different numbers of photons are collected per unit time (per ms here). 

(ref:confocal-volume-particle-caption) Left: a fluorophore diffusing trhough the confocal volume. Right: the intensity trace due to this fluorophore. 

```{r confocal-volume-particle, message=FALSE, fig.show='hold', out.width='50%', fig.cap='(ref:confocal-volume-particle-caption)', echo=FALSE}
set.seed(9)
cvp_png <- here("img", "cvp.png")
df_intensity_trace <- tibble(time = seq_len(100),
                             intensity = detrendr:::myrpois(c(rep(0, 30), 
                                                              rep(0.7, 40), 
                                                              rep(0, 30)))) 
p <- ggplot(df_intensity_trace) + aes(time, intensity) + 
  geom_bar(stat = "identity") + ylab("time (ms)")
ggsave(cvp_png, p, width = 2, height = 1.5)
include_graphics(c(here("img", "confocal_volume_particle.png"), cvp_png))
```

```{definition}
The time-series of intensity counts in a given pixel or image is referred to as its _intensity trace_.
```


## Fluorescence fluctuation spectroscopy

Broadly, fluorescence fluctuation spectroscopy (FFS) is the analysis of the intensity fluctuation of a fluorescence signal [@FFS]. This very often takes the form of moment analysis^[https://en.wikipedia.org/wiki/Method_of_moments_(statistics)] [@QianElson]. Briefly, moment analysis is an attempt to extract data from a distribution of values using its _moments_. The first moment of a distribution is its mean value, the second moment is its variance and so on. Intensity traces can be viewed as distributions with moments. For example, the intensity trace in figure \@ref(fig:confocal-volume-particle) has mean `r round(mean(df_intensity_trace$intensity), 2)` and variance  `r round(var(df_intensity_trace$intensity), 2)`. 


### Number and brightness {#number-and-brightness}

_Number and brightness_ (N&B, @NB) is an FFS technique for quantifying the oligomeric states of fluorescently labelled proteins. What follows is a mathematical description of the technique.

> ```{definition}
An _entity_ is a set of molecules which are chemically bound.
```
```{definition}
The brightness $\epsilon$ of an entity is the mean number of photon detector counts it gives per unit time when in the illumination (confocal) volume.
```
For an image series where the $i$^th^ slice in the stack is the image acquired at time $t = i$, for a given pixel position $(x, y)$, we define $\langle I \rangle$ as the mean intensity of that pixel over the image series and $\sigma^2$ as the variance in that intensity. Define $n$ as the mean number of entities in the illumination volume corresponding to that pixel. Assuming that all entities are mobile, we have
\begin{align}
N &= \frac{\langle I \rangle^2}{\sigma^2} = \frac{\epsilon n}{1 + \epsilon} (\#eq:NB1-1) \\
B &= \frac{\sigma^2}{\langle I \rangle} = 1 + \epsilon 
(\#eq:NB1-2)
\end{align}
where $N$ and $B$ are referred to as the “apparent number” and “apparent brightness” respectively. This gives
\begin{align}
\epsilon &= \frac{\sigma^2}{\langle I \rangle} - 1 (\#eq:NB2-1) \\
n &= \frac{\langle I \rangle^2}{\sigma^2 - \langle I \rangle} (\#eq:NB2-2)
\end{align}
> 
> --- @NBreview^[This is a formulation of N&B that I wrote in a 2017 review of the technique.]

The quantity $\epsilon$ is a relative measure of oligomeric state. That is, $\epsilon$ will be twice as big for dimers as it is for monomers, three times as big for trimers as it is for monomers and so on.

The way that N&B experiments to determine unknown oligomeric states are generally done is as follows:

1. For a given laser power and fluorophore with a system where all entities are known to be monomeric, measure the brightness $\epsilon$. Call this $\epsilon_\text{monomer}$.
1. With the same laser power and fluorophore but now with a system where the oligomeric state is unknown, measure the brightness $\epsilon$ again. Call this $\epsilon_\text{unknown}$.
1. The unknown oligomeric state is equal to $\epsilon_\text{unknown} / \epsilon_\text{monomer}$. 

Number and brightness has specific pixel dewll-time and frame rate requirements. These were first articulated in my 2017 review of N&B. 
```{definition}
The _pixel dwell time_ $t_\text{dwell}$ of a scanning confocal microscope is the amount of time it spends collecting photons at each given pixel before moving on to the next pixel.
```
```{definition}
The _frame time_ of a scanning confocal microscope is the amount of time it takes to acquire the data for all of the pixels in a whole frame. That is the length of time from the start of detectionion of photons from the first pixel to the end of detection of photons from the last pixel.
```
```{definition}
The mean _residence time_ $\tau_D$ of a particle in the confocal volume is the average length of time that a particle that enters the confocal volume resides in that volume before exiting.
```
The requirement is $t_\text{dwell} \ll \tau_D \ll t_\text{frame}$. This ensures that: 

1. When acquiring photons at a given pixel, the underlying configuration of entities is constant (there's not enough time for the entities to move and change their configuration). 
1. When the scanner returns to a given pixel (one frame time later), the underlying configuration has changed totally since the last time the scanner was at this pixel (because so much time has passed, all of the diffusing entities have moved a lot in the meantime).

Both of these points are implicitly assumed in the derivation of the N&B equations so it is essential to get these acquisition parameters right. This is discussed at length in @NBreview.

An important property of N&B is that if all fluorescent particles are immobile, then $B = 1$. This is because photon emission from stationary sources happens according to a poisson distribution. Poisson distributions have variance equal to mean, this implies $\sigma^2$ = $\langle I \rangle$ which gives $B = \frac{\sigma^2}{\langle I \rangle} = 1$.

The N&B technique is fraught with technical difficulties. Principal of these is the problem of photobleaching. Much of my PhD focussed on corrections for photobleaching. This is discussed in chapter \@ref(photobleaching-correction). 


## Fluorescence correlation spectroscopy

Fluorescence correlation spectroscopy (FCS) is the correlation analysis of fluorescence intensity fluctuations.^[https://en.wikipedia.org/wiki/Fluorescence_correlation_spectroscopy] For this reason, FCS can be described as a subfield of FFS [@FFSnewage]. In practice, FFS is mostly used to refer to the non-FCS parts of the whole FFS field. I will follow that convention.

First, let us introduce some concepts from statistics.

```{definition, name='statistics'}
The _correlation_ between two random variables $X$ and $Y$ with expected values $\mu_X$ and $\mu_Y$ and standard deviations $\sigma_X$ and $\sigma_Y$ is
\begin{equation}
\text{corr}(X, Y) = \frac{E[(X - \mu_X)(Y - \mu_Y)]}{\sigma_X \sigma_Y}
(\#eq:correlation)
\end{equation}
where $E$ is the expectation operator.^[https://en.wikipedia.org/wiki/Correlation_and_dependence]
```

```{definition, name='statistics'}
_Autocorrelation_ $G(X; \tau)$, is the correlation of a signal $X$ with a delayed copy of itself as a function of the delay $\tau$.^[https://en.wikipedia.org/wiki/Autocorrelation]
\begin{equation}
G(X; \tau) = \text{corr}(X_t, X_{t + \tau}) = \frac{E[(X_t - \mu_X)(X_{t + \tau} - \mu_X)]}{\sigma^2_X}
(\#eq:autocorrelation)
\end{equation}
```

```{definition, name='statistics'}
The _cross-correlation_ of two series is the correlation of one with a delayed copy of the other as a function of the delay.
\begin{equation}
\text{crosscorr}(X, Y; \tau) = \text{corr}(X_t, Y_{t + \tau}) = \frac{E[(X_t - \mu_X)(Y_{t + \tau} - \mu_Y)]}{\sigma_X \sigma_Y}
(\#eq:crosscorrelation)
\end{equation}
```

For the purposes of FCS, these quantities were redefined as follows. 

```{definition, name='FCS'}
The _correlation_ between two random variables $X$ and $Y$ with expected values $\mu_X$ and $\mu_Y$ and standard deviations $\sigma_X$ and $\sigma_Y$ is
\begin{equation}
\text{corr}(X, Y) = \frac{E[(X - \mu_X)(Y - \mu_Y)]}{\mu_X \mu_Y}
(\#eq:FCScorrelation)
\end{equation}
where $E$ is the expectation operator.^[https://en.wikipedia.org/wiki/Correlation_and_dependence]
```

```{definition, name='FCS'}
_Autocorrelation_ $G(X; \tau)$, is the correlation of a signal $X$ with a delayed copy of itself as a function of the delay $\tau$.^[https://en.wikipedia.org/wiki/Autocorrelation]
\begin{equation}
G(X; \tau) = \text{corr}(X_t, X_{t + \tau}) = \frac{E[(X_t - \mu_X)(X_{t + \tau} - \mu_X)]}{\mu^2_X}
(\#eq:FCSautocorrelation)
\end{equation}
```

```{definition, name='FCS'}
The _cross-correlation_ of two series is the correlation of one with a delayed copy of the other as a function of the delay.
\begin{equation}
\text{crosscorr}(X, Y; \tau) = \text{corr}(X_t, Y_{t + \tau}) = \frac{E[(X_t - \mu_X)(Y_{t + \tau} - \mu_Y)]}{\mu_X \mu_Y}
(\#eq:FCScrosscorrelation)
\end{equation}
```

The reason for these redefinitions (which just involve replacing standard deviations with means in the denominators of each expression) is that with the FCS definition, the autocorrelation has the nice property that for normal diffusion

\begin{equation}
G(X; 0) = \frac{1}{n}
(\#eq:FCSautocorrprop)
\end{equation}

where $n$ is the mean number of fluorescent particles in the focal volume. The convenience of the statistics definitions is that there, correlations are guaranteed to be in $[-1, 1]$, with $0$ representing no correlation, $1$ perfect positive correlation and $-1$ perfect negative correlation; this is lost with the FCS definitions.

I felt it necessary to provide these definitions for two reasons:

1. It is important for people from the fields of FCS and pure mathematics/statistics to know that they have different definitions for the same thing.
1. In FCS, it's very common for people to mistake correlation for cross-correlation. This is unfortunate, but knowing about this common mistake is essential for navigating the field in a sensible manner. It seems that when people in the field correlate the signals from two separate channels, the use the term _cross_-correlation, even though they're only using correlation. I think the idea of working _across_ two or more channels (and ideas such as _cross_-talk) leads to this confustion.

Henceforth, the FCS defintions of these quantities will be assumed.


### Correlation {#correlation}

Suppose that two proteins of interest A and B are labelled with red and green fluorophores respectively (and there is no bleed-through between these red and green channels). 
1. If these proteins are interacting, then
  * interaction implies that A and B are _stuck_ together
  * this implies that A and B co-diffuse
  * this implies that for a given volumen in the sample
    - more of A implies more of B
    - less of A implies less of B
    - more of B implies more of A
    - less of B implies less of A
Since the number of photons emitted is proportional to the amount of fluorophores present, it follows that
  * more red photons implies more green photons
  * less red photons implies less green photons
  * more green photons implies more red photons
  * less green photons implies less red photons
Altogether, this implies that the intensity traces from the red and green channels will be correlated. 
2. If these proteins are not interacting, then the intensity traces from the red and green channels will not be correlated. 

Thus, interaction of red A and green B necessarily leads to correlation in fluorescent signals from the red and green chanels.^[This correlation may not always be detectable due to weak interaction or weak signal.]


### Autocorrelation

As mentioned already, the autocorrelation function (ACF) can be used to count the number of particles in the confocal volume. It can also be used to measure diffusion coefficients for various types of diffusion (normal, anomalous, polydisperse, etc.). The ACF is not used in my PhD.


### Cross-correlation

The cross-correlation of intensity traces from nearby pixels can be used to measure the velocity of the movement of the labelled particles between these two pixels [@STICS]. It can also be used to image barriers to diffusion [@PCF].


### Cross-correlated brightness

_Cross-correlated brightness_ [@ccNB] moulds the correlation idea (section \@ref(correlation)) into the framework of N&B. Suppose there are two channels with intensities $I_1$ and $I_2$. 

```{definition, name='cross-variance'}

\begin{equation}
\sigma^2_\text{cc} = E[(I_2 - \langle I_1 \rangle)(I_2 - \langle I_2 \rangle)]
(\#eq:cross-var)
\end{equation}

```

```{definition, name='cross-correlated brightness'}

\begin{equation}
B_\text{cc} = \frac{\sigma^2_\text{cc}}{\sqrt{\langle I_1 \rangle \langle I_2 \rangle}}
(\#eq:cross-corr-nb)
\end{equation}

```

$B_\text{cc}$ is related to $\text{corr}(I_1, I_2)$ by
\begin{equation}
B_\text{cc} = \sqrt{\langle I_1 \rangle \langle I_2 \rangle} \times \text{corr}(I_1, I_2)
(\#eq:bcc-corr)
\end{equation}
This means that $B_\text{cc}$ is just a scaled version of correlation. The need for this redefinition is unclear (but it is no harm). It does make the formula look like the brightness formula \@ref(eq:NB1-2), but no such oligomeric state information can be gleaned from $B_\text{cc}$. It is merely useful as a relative measure of interaction: higher $B_\text{cc}$ means more interaction, lower $B_\text{cc}$ means less interaction. It is commonly used to identify interactions. Then, conventional N&B performed on each of the channels (1 and 2) can be used to measure the stoichiometry of the interaction. See @ccNB for details.

```{remark}
Since cross-correlated brightness uses correlation but not cross-correlation, it is a prime example of the confusing naming that pervades FCS. It should be called _correlated brightness_. Rather than rename it, I will continue to refer to it as cross-correlated brightness.
```

